// backend/prisma/schema.prisma

// 1. 設定資料庫連線
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 2. 設定 Prisma Client 產生器
generator client {
  provider = "prisma-client-js"
}

// 3. 定義您的資料模型 (Models) 和枚舉 (Enums)

// --- Enums (枚舉) ---

enum UserRole {
  admin
  operator
}

enum OrderStatus {
  Pending
  Processing
  Shipped_Internal
  Warehouse_Received
  Completed
  Cancelled
}

enum OrderType {
  Standard  // 一般商城訂單
  Assist    // 代客採購訂單
}

// --- Models (資料模型) ---

model SystemSettings {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  description String?
  updated_at  DateTime @default(now())

  @@map("system_settings")
}

// 管理員/操作員
model Users {
  id            Int      @id @default(autoincrement())
  username      String   @unique
  password_hash String
  role          UserRole @default(operator)
  status        String   @default("active")
  created_at    DateTime @default(now())

  orders Orders[]

  @@map("users")
}

// 分類
model Categories {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  created_at  DateTime @default(now())

  products Products[]

  @@map("categories")
}

// 商品
model Products {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  images      String[]
  specs       String[] // [新增] 規格選項 (如: ["紅色", "藍色", "S", "M"])
  cost_cny    Decimal
  price_twd   Int
  is_archived Boolean  @default(false)
  created_at  DateTime @default(now())

  category_id Int?
  category    Categories? @relation(fields: [category_id], references: [id])

  order_items OrderItems[]

  @@map("products")
}

// 訂單
model Orders {
  id                       Int         @id @default(autoincrement())
  paopao_id                String
  customer_email           String?
  total_amount_twd         Int
  total_cost_cny           Decimal
  status                   OrderStatus @default(Pending)
  type                     OrderType   @default(Standard)
  operator_id              Int?
  warehouse_id             Int?
  notes                    String?
  payment_voucher_url      String?     // 匯款憑證 URL
  domestic_tracking_number String?     // 大陸境內物流單號
  created_at               DateTime    @default(now())

  payment_method String?
  payment_status String  @default("UNPAID")

  share_token String @unique @default(uuid())

  operator  Users?      @relation(fields: [operator_id], references: [id])
  warehouse Warehouses? @relation(fields: [warehouse_id], references: [id])
  items     OrderItems[]

  @@map("orders")
}

// 訂單內的商品 (關聯表)
model OrderItems {
  id                 Int     @id @default(autoincrement())
  order_id           Int
  product_id         Int?
  item_url           String?
  item_spec          String? // 這裡原本就有，現在會真正被使用到
  quantity           Int
  snapshot_name      String?
  snapshot_price_twd Int
  snapshot_cost_cny  Decimal

  order   Orders    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product Products? @relation(fields: [product_id], references: [id])

  @@map("order_items")
}

// 倉庫
model Warehouses {
  id         Int      @id @default(autoincrement())
  name       String   @unique
  receiver   String
  phone      String
  address    String
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())

  orders Orders[]

  @@map("warehouses")
}

// 客戶 (會員)
model Customers {
  id            Int      @id @default(autoincrement())
  paopao_id     String   @unique
  password_hash String
  email         String   @unique
  phone         String?
  created_at    DateTime @default(now())

  @@map("customers")
}